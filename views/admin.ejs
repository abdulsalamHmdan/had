<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            box-sizing: border-box;
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .status-accepted {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .status-pending {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }

        .status-rejected {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .stat-card {
            position: relative;
            overflow: hidden;
        }

        .stat-card.selected {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            transform: scale(1.05);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            border-color: #1d4ed8;
        }

        .stat-card.selected p {
            color: rgba(255, 255, 255, 0.9);
        }

        .stat-card.selected .text-green-600,
        .stat-card.selected .text-yellow-600,
        .stat-card.selected .text-red-600,
        .stat-card.selected .text-blue-600 {
            color: white !important;
        }

        .stat-card:not(.selected) {
            opacity: 0.7;
            filter: grayscale(0.3);
        }

        .stat-card:not(.selected):hover {
            opacity: 1;
            filter: grayscale(0);
        }

        .stat-card.selected::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, rgba(255, 255, 255, 0.1) 0%, transparent 50%, rgba(255, 255, 255, 0.1) 100%);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% {
                transform: translateX(-100%);
            }

            100% {
                transform: translateX(100%);
            }
        }
    </style>
</head>

<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen font-sans">
    <!-- Header -->
    <header class="bg-white shadow-lg border-b-4 border-blue-500">
        <div class="max-w-7xl mx-auto px-6 py-4">
            <div class="flex justify-between items-center">
                <h1 class="text-3xl font-bold text-gray-800 flex items-center">
                    <span class="bg-blue-500 text-white p-2 rounded-lg ml-3">ğŸ“‹</span>
                    Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª
                </h1>
                <div class="flex items-center space-x-4 space-x-reverse">
                    <div class="bg-blue-100 px-4 py-2 rounded-lg">
                        <span class="text-blue-800 font-semibold" id="totalBookings">0 Ø­Ø¬Ø²</span>
                    </div>
                    <button onclick="exportData()"
                        class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors">
                        ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                    </button>
                    <button onclick="(()=>{location.href='logout'})()"
                        class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-colors">
                        ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Filters -->
    <div class="max-w-7xl mx-auto px-6 py-6">
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4">ğŸ” ÙÙ„ØªØ±Ø© Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª</h2>
            <div class="grid grid-cols-1 md:grid-cols-6 gap-4">
                <select id="statusFilter"
                    class="border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
                    <option value="yes">Ù…Ù‚Ø¨ÙˆÙ„Ø©</option>
                    <option value="pending">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</option>
                    <option value="no">Ù…Ø±ÙÙˆØ¶Ø©</option>
                </select>
                <select id="bookingTypeFilter"
                    class="border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="">Ø¬Ù…ÙŠØ¹ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø­Ø¬Ø²</option>
                    <option value="Ø§Ù„Ø§Ø³ØªØ±Ø§Ø­Ø©">Ø§Ù„Ø§Ø³ØªØ±Ø§Ø­Ø©</option>
                    <option value="Ø§Ù„Ù…Ø®ÙŠÙ…">Ø§Ù„Ù…Ø®ÙŠÙ…</option>
                </select>
                <select id="entityTypeFilter"
                    class="border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="">Ø¬Ù…ÙŠØ¹ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø¬Ù‡Ø§Øª</option>
                    <option value="Ø­ÙƒÙˆÙ…ÙŠ">Ø­ÙƒÙˆÙ…ÙŠ</option>
                    <option value="Ø®Ø§Øµ">Ø®Ø§Øµ</option>
                    <option value="Ø®ÙŠØ±ÙŠ">Ø®ÙŠØ±ÙŠ(Ø¬Ù…Ø¹ÙŠØ§Øª Ø®ÙŠØ±ÙŠØ© - Ø­Ù„Ù‚Ø§Øª - Ø£Ù†Ø¯ÙŠØ© ØªØ±Ø¨ÙˆÙŠØ©)</option>
                </select>
                <select id="periodFilter"
                    class="border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØªØ±Ø§Øª</option>
                    <option value="ØµØ¨Ø§Ø­ÙŠ">ØµØ¨Ø§Ø­ÙŠ</option>
                    <option value="Ù…Ø³Ø§Ø¦ÙŠ">Ù…Ø³Ø§Ø¦ÙŠ</option>
                </select>
                <select id="timeFilter"
                    class="border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®</option>
                    <option value="thisWeek">Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</option>
                    <option value="thisMonth">Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</option>
                    <option value="expired">Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ©</option>
                </select>
                <input type="text" id="searchFilter" placeholder="Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ù‡Ø§ØªÙ..."
                    class="border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
            <div id="acceptedCard" onclick="filterByStatus('yes')"
                class="stat-card bg-white rounded-xl shadow-lg p-6 border-r-4 border-green-500 cursor-pointer hover:shadow-xl transition-all duration-300 hover:scale-105">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm">Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„Ù…Ù‚Ø¨ÙˆÙ„Ø©</p>
                        <p class="text-2xl font-bold text-green-600" id="acceptedCount">0</p>
                    </div>
                    <div class="bg-green-100 p-3 rounded-full">
                        <span class="text-2xl">âœ…</span>
                    </div>
                </div>
            </div>
            <div id="pendingCard" onclick="filterByStatus('pending')"
                class="stat-card bg-white rounded-xl shadow-lg p-6 border-r-4 border-yellow-500 cursor-pointer hover:shadow-xl transition-all duration-300 hover:scale-105">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</p>
                        <p class="text-2xl font-bold text-yellow-600" id="pendingCount">0</p>
                    </div>
                    <div class="bg-yellow-100 p-3 rounded-full">
                        <span class="text-2xl">â³</span>
                    </div>
                </div>
            </div>
            <div id="rejectedCard" onclick="filterByStatus('no')"
                class="stat-card bg-white rounded-xl shadow-lg p-6 border-r-4 border-red-500 cursor-pointer hover:shadow-xl transition-all duration-300 hover:scale-105">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm">Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„Ù…Ø±ÙÙˆØ¶Ø©</p>
                        <p class="text-2xl font-bold text-red-600" id="rejectedCount">0</p>
                    </div>
                    <div class="bg-red-100 p-3 rounded-full">
                        <span class="text-2xl">âŒ</span>
                    </div>
                </div>
            </div>
            <div id="totalCard" onclick="filterByStatus('')"
                class="stat-card bg-white rounded-xl shadow-lg p-6 border-r-4 border-blue-500 cursor-pointer hover:shadow-xl transition-all duration-300 hover:scale-105 selected">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª</p>
                        <p class="text-2xl font-bold text-blue-600" id="totalCount">0</p>
                    </div>
                    <div class="bg-blue-100 p-3 rounded-full">
                        <span class="text-2xl">ğŸ“Š</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bookings Table -->
        <div class="bg-white rounded-xl shadow-lg overflow-hidden">
            <div class="px-6 py-4 bg-gray-50 border-b">
                <h2 class="text-xl font-bold text-gray-800">ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª</h2>
            </div>
            <div class="overflow-x-auto">
                <table id="table" class="w-full">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Ø§Ù„Ø­Ø§Ù„Ø©</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Ù†ÙˆØ¹ Ø§Ù„Ø­Ø¬Ø²</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Ø§Ø³Ù… Ø§Ù„Ø­Ø§Ø¬Ø²</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Ø§Ù„Ù‡Ø§ØªÙ</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Ø§Ø³Ù… Ø§Ù„Ø¬Ù‡Ø©</th>
                            <!-- <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Ù†ÙˆØ¹ Ø§Ù„Ø¬Ù‡Ø©</th> -->
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Ø§Ù„ÙØªØ±Ø©</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                ÙˆØ§ØªØ³Ø§Ø¨</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ</th>
                        </tr>
                    </thead>
                    <tbody id="bookingsTable" class="bg-white divide-y divide-gray-200">
                        <!-- Bookings will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>


        <div class="bg-white rounded-xl shadow-lg overflow-hidden mt-7">
            <div class="mx-auto text-center px-6 py-4 bg-gray-50 border-b ">
                <a href="/days" class="text-xl font-bold text-gray-800">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ© ğŸ“…</a>
            </div>
        </div>

    </div>

    <!-- Booking Details Modal -->
    <div id="bookingModal"
        class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-90vh overflow-y-auto">
            <div class="px-6 py-4 bg-blue-500 text-white rounded-t-xl">
                <h3 class="text-xl font-bold">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø¬Ø²</h3>
            </div>
            <div id="modalContent" class="p-6">
                <!-- Modal content will be populated here -->
            </div>
            <div class="px-6 py-4 bg-gray-50 rounded-b-xl flex justify-end space-x-3 space-x-reverse">
                <button onclick="closeModal()"
                    class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors">
                    Ø¥ØºÙ„Ø§Ù‚
                </button>
            </div>
        </div>
    </div>

    <!-- Status Change Modal -->
    <div id="loading" class="fixed inset-0 bg-black bg-opacity-50 flex hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl p-8 max-w-md mx-4 text-center">
            <h3 class="text-2xl font-bold text-gray-800 mb-2">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</h3>
            <!-- <p class="text-gray-600 mb-6">ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø­Ø¬Ø²Ùƒ ÙˆØ³ÙŠØªÙ… Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ Ù‚Ø±ÙŠØ¨Ø§Ù‹</p> -->
        </div>
    </div>
    <div id="statusChangeModal"
        class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full">
            <div class="px-6 py-4 bg-orange-500 text-white rounded-t-xl">
                <h3 class="text-xl font-bold">ØªØ¹Ø¯ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø¬Ø²</h3>
            </div>
            <div class="p-6">
                <div class="mb-4">
                    <p class="text-gray-700 mb-2">Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</p>
                    <div id="currentStatus" class="mb-4"></div>
                    <div id="obid" class="mb-4 hidden"></div>
                </div>
                <div class="mb-6">
                    <p class="text-gray-700 mb-3">Ø§Ø®ØªØ± Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:</p>
                    <div class="space-y-3">
                        <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
                            <input type="radio" name="newStatus" value="yes" class="ml-3">
                            <span class="flex items-center">
                                <span class="text-green-600 ml-2">âœ…</span>
                                Ù…Ù‚Ø¨ÙˆÙ„
                            </span>
                        </label>
                        <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
                            <input type="radio" name="newStatus" value="pending" class="ml-3">
                            <span class="flex items-center">
                                <span class="text-yellow-600 ml-2">â³</span>
                                Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©
                            </span>
                        </label>
                        <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
                            <input type="radio" name="newStatus" value="no" class="ml-3">
                            <span class="flex items-center">
                                <span class="text-red-600 ml-2">âŒ</span>
                                Ù…Ø±ÙÙˆØ¶
                            </span>
                        </label>
                    </div>
                </div>
            </div>
            <div class="px-6 py-4 bg-gray-50 rounded-b-xl flex justify-end space-x-3 space-x-reverse">
                <button onclick="closeStatusChangeModal()"
                    class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors">
                    Ø¥Ù„ØºØ§Ø¡
                </button>
                <button onclick="confirmStatusChange()"
                    class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg transition-colors">
                    ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØºÙŠÙŠØ±
                </button>
            </div>
        </div>
    </div>


    <script>
        // Sample bookings data
        let bookings = JSON.parse('<%-arr%>');
        let filteredBookings = [...bookings];

        function getStatusBadge(status) {
            const statusMap = {
                'yes': { text: 'Ù…Ù‚Ø¨ÙˆÙ„', class: 'status-accepted', icon: 'âœ…' },
                'pending': { text: 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©', class: 'status-pending', icon: 'â³' },
                'no': { text: 'Ù…Ø±ÙÙˆØ¶', class: 'status-rejected', icon: 'âŒ' }
            };
            const statusInfo = statusMap[status] || statusMap['pending'];
            return `<span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium text-white ${statusInfo.class}">
                ${statusInfo.icon} ${statusInfo.text}
            </span>`;
        }
        function isDateInThisWeek(dateString) {
            const date = new Date(dateString);
            const today = new Date();
            const startOfWeek = new Date(today);
            startOfWeek.setDate(today.getDate() - today.getDay());
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);

            return date >= startOfWeek && date <= endOfWeek;
        }

        function isDateInThisMonth(dateString) {
            const date = new Date(dateString);
            const today = new Date();
            return date.getMonth() === today.getMonth() && date.getFullYear() === today.getFullYear();
        }

        function isDateExpired(dateString) {
            const date = new Date(dateString);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            return date < today;
        }

        function sendWhatsApp(phone, name, entityName, date, status) {
            const statusMap = {
                'yes': { text: 'Ù…Ù‚Ø¨ÙˆÙ„', class: 'status-accepted', icon: ' âœ…' },
                'pending': { text: 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©', class: 'status-pending', icon: ' â³' },
                'no': { text: 'Ù…Ø±ÙÙˆØ¶', class: 'status-rejected', icon: ' âŒ' }
            };
            const message = `Ù…Ø±Ø­Ø¨Ø§Ù‹ ${name}ØŒ\n\nÙ†ÙÙŠØ¯ÙƒÙ… Ø¨Ø£Ù† Ø­Ø¬Ø²ÙƒÙ…  Ù„Ù€${entityName} Ø¨ØªØ§Ø±ÙŠØ® ${date}\n\n{{ ${statusMap[status].text}${statusMap[status].icon} }}\n\nØ´ÙƒØ±Ø§Ù‹ Ù„ÙƒÙ….`;
            const encodedMessage = encodeURIComponent(message);
            const whatsappUrl = "https://api.whatsapp.com/send/?phone=" + phone.replace(/^0/, '966') + "&text=" + encodedMessage;
            window.open(whatsappUrl, '_blank', 'noopener,noreferrer');
        }

        function renderBookings() {
            const tbody = document.getElementById('bookingsTable');
            tbody.innerHTML = '';

            filteredBookings.forEach((booking, index) => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 fade-in';

                // Add visual indicator for expired dates
                const isExpired = isDateExpired(booking.date);
                if (isExpired) {
                    row.className += ' bg-red-50';
                }

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">${getStatusBadge(booking.accepted)}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${booking.type === 'Ø§Ø³ØªØ±Ø§Ø­Ø©' ? 'bg-purple-100 text-purple-800' : 'bg-green-100 text-green-800'}">
                            ${booking.type === 'Ø§Ù„Ø§Ø³ØªØ±Ø§Ø­Ø©' ? 'ğŸ¡' : 'ğŸŒ¾'} ${booking.type}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap font-medium text-gray-900">${booking.bookerName}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-gray-600">${booking.bookerPhone}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-gray-900">${booking.entityName}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-gray-600">
                        ${booking.date}
                        ${isExpired ? '<span class="text-red-500 text-xs block">Ù…Ù†ØªÙ‡ÙŠ</span>' : ''}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-gray-600">${booking.timePeriod}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-gray-600">${booking.expectedCount} Ø´Ø®Øµ</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <button onclick="sendWhatsApp('${booking.bookerPhone}', '${booking.bookerName}', '${booking.entityName}', '${booking.date}','${booking.accepted}')" 
                                class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-xs transition-colors flex items-center">
                            ğŸ“± Ø¥Ø±Ø³Ø§Ù„
                        </button>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <div class="flex space-x-2 space-x-reverse">
                            <button onclick="viewBooking(${index})" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-xs transition-colors">
                                Ø¹Ø±Ø¶
                            </button>
                            ${booking.accepted === 'pending' ? `
                                <button onclick="updateStatus(${index}, 'yes','${booking["_id"]}')" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-xs transition-colors">
                                    Ù‚Ø¨ÙˆÙ„
                                </button>
                                <button onclick="updateStatus(${index}, 'no','${booking["_id"]}')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-xs transition-colors">
                                    Ø±ÙØ¶
                                </button>
                            ` : `
                                <button onclick="showStatusChangeModal(${index})" class="bg-orange-500 hover:bg-orange-600 text-white px-3 py-1 rounded text-xs transition-colors">
                                    ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø©
                                </button>
                            `}
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap" onclick="deleteHjz(${index},'${booking["_id"]}')">
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">
                            Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ âŒ
                        </span>
                    </td>
                `;
                tbody.appendChild(row);
            });

            updateStatistics();
        }

        function updateStatistics() {
            const accepted = filteredBookings.filter(b => b.accepted === 'yes').length;
            const pending = filteredBookings.filter(b => b.accepted === 'pending').length;
            const rejected = filteredBookings.filter(b => b.accepted === 'no').length;
            const total = filteredBookings.length;

            document.getElementById('acceptedCount').textContent = accepted;
            document.getElementById('pendingCount').textContent = pending;
            document.getElementById('rejectedCount').textContent = rejected;
            document.getElementById('totalCount').textContent = total;
            document.getElementById('totalBookings').textContent = `${total} Ø­Ø¬Ø²`;
        }

        function applyFilters() {
            const statusFilter = document.getElementById('statusFilter').value;
            const bookingTypeFilter = document.getElementById('bookingTypeFilter').value;
            const entityTypeFilter = document.getElementById('entityTypeFilter').value;
            const periodFilter = document.getElementById('periodFilter').value;
            const timeFilter = document.getElementById('timeFilter').value;
            const searchFilter = document.getElementById('searchFilter').value.toLowerCase();

            filteredBookings = bookings.filter(booking => {
                const matchesStatus = !statusFilter || booking.accepted === statusFilter;
                const matchesBookingType = !bookingTypeFilter || booking.type === bookingTypeFilter;
                const matchesEntityType = !entityTypeFilter || booking.entityType === entityTypeFilter;
                const matchesPeriod = !periodFilter || booking.timePeriod === periodFilter;
                const matchesSearch = !searchFilter ||
                    booking.bookerName.toLowerCase().includes(searchFilter) ||
                    booking.bookerPhone.includes(searchFilter) ||
                    booking.entityName.toLowerCase().includes(searchFilter);

                let matchesTime = true;
                if (timeFilter) {
                    switch (timeFilter) {
                        case 'thisWeek':
                            matchesTime = isDateInThisWeek(booking.date);
                            break;
                        case 'thisMonth':
                            matchesTime = isDateInThisMonth(booking.date);
                            break;
                        case 'expired':
                            matchesTime = isDateExpired(booking.date);
                            break;
                    }
                }

                return matchesStatus && matchesBookingType && matchesEntityType && matchesPeriod && matchesSearch && matchesTime;
            });

            renderBookings();
        }

        function viewBooking(index) {
            const booking = filteredBookings[index];
            const modalContent = document.getElementById('modalContent');

            modalContent.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-4">
                        <h4 class="font-bold text-lg text-gray-800 border-b pb-2">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø­Ø¬ÙˆØ²</h4>
                        <div><span class="font-semibold">Ø§Ù„Ø§Ø³Ù…:</span> ${booking.bookerName}</div>
                        <div><span class="font-semibold">Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©:</span> ${booking.idNumber}</div>
                        <div><span class="font-semibold">Ø§Ù„Ù‡Ø§ØªÙ:</span> ${booking.bookerPhone}</div>
                        <div><span class="font-semibold">Ø§Ø³Ù… Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„:</span> ${booking.managerName}</div>
                        <div><span class="font-semibold">Ù‡Ø§ØªÙ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„:</span> ${booking.managerPhone}</div>
                    </div>
                    <div class="space-y-4">
                        <h4 class="font-bold text-lg text-gray-800 border-b pb-2">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø¬Ø²</h4>
                        <div><span class="font-semibold">Ù†ÙˆØ¹ Ø§Ù„Ø­Ø¬Ø²:</span> ${booking.type}</div>
                        <div><span class="font-semibold">Ø§Ø³Ù… Ø§Ù„Ø¬Ù‡Ø©:</span> ${booking.entityName}</div>
                        <div><span class="font-semibold">Ù†ÙˆØ¹ Ø§Ù„Ø¬Ù‡Ø©:</span> ${booking.entityType}</div>
                        <div><span class="font-semibold">Ø§Ù„ØªØ§Ø±ÙŠØ®:</span> ${booking.date}</div>
                        <div><span class="font-semibold">Ø§Ù„ÙØªØ±Ø©:</span> ${booking.timePeriod}</div>
                        <div><span class="font-semibold">ÙˆÙ‚Øª Ø§Ù„Ø¯Ø®ÙˆÙ„:</span> ${booking.entryTime}</div>
                        <div><span class="font-semibold">ÙˆÙ‚Øª Ø§Ù„Ø®Ø±ÙˆØ¬:</span> ${booking.exitTime}</div>
                        <div><span class="font-semibold">Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹:</span> ${booking.expectedCount} Ø´Ø®Øµ</div>
                        <div><span class="font-semibold">Ø§Ù„Ø­Ø§Ù„Ø©:</span> ${getStatusBadge(booking.accepted)}</div>
                    </div>
                </div>
            `;

            document.getElementById('bookingModal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('bookingModal').classList.add('hidden');
        }

        let currentBookingIndex = -1;

        function showStatusChangeModal(index) {
            currentBookingIndex = index;
            const booking = filteredBookings[index];

            // Show current status
            document.getElementById('currentStatus').innerHTML = getStatusBadge(booking.accepted);
            document.getElementById('obid').innerHTML = booking["_id"];

            // Clear previous selections
            const radios = document.querySelectorAll('input[name="newStatus"]');
            radios.forEach(radio => radio.checked = false);


            document.getElementById('statusChangeModal').classList.remove('hidden');
        }

        function closeStatusChangeModal() {
            document.getElementById('statusChangeModal').classList.add('hidden');
        }

        function confirmStatusChange() {
            const selectedStatus = document.querySelector('input[name="newStatus"]:checked');
            if (!selectedStatus) {
                alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©');
                return;
            }
            const newStatus = selectedStatus.value;
            const id = document.getElementById('obid').innerText;
            closeStatusChangeModal();
            updateStatus(currentBookingIndex, newStatus, id);

        }

        function updateStatus(index, newStatus, id) {
            const booking = filteredBookings[index];
            const originalIndex = bookings.findIndex(b =>
                b.bookerName === booking.bookerName &&
                b.bookerPhone === booking.bookerPhone &&
                b.date === booking.date
            );
            document.getElementById('loading').classList.remove('hidden');

            var data = new URLSearchParams();
            data.append('id', id);
            data.append('st', newStatus);
            fetch('changeS', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8'
                },
                body: data
            }).then(() => {
                document.getElementById('loading').classList.add('hidden');
                currentBookingIndex = -1;
                bookings[originalIndex].accepted = newStatus;
                applyFilters();
                const statusText = newStatus === 'yes' ? 'Ù‚ÙØ¨Ù„' : newStatus === 'no' ? 'Ø±ÙÙØ¶' : 'ØªÙ… ØªØ­ÙˆÙŠÙ„Ù‡ Ù„Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©';
                alert(`ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø¬Ø² - ${statusText} Ø¨Ù†Ø¬Ø§Ø­!`);

            }).catch(() => {
                alert("Ø­ØµÙ„Øª Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¯ ØªØ¶Ø·Ø± Ø§Ù„Ù‰ Ø§Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§Ø¯Ø®Ø§Ù„");
                location.reload();
            })
        }


        function deleteHjz(index, id) {
            const booking = filteredBookings[index];
            const originalIndex = bookings.findIndex(b =>
                b.bookerName === booking.bookerName &&
                b.bookerPhone === booking.bookerPhone &&
                b.date === booking.date
            );
            document.getElementById('loading').classList.remove('hidden');

            var data = new URLSearchParams();
            data.append('collection', 'hjz');
            data.append('id', id);
            fetch('delete', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8'
                },
                body: data
            }).then(() => {
                document.getElementById('loading').classList.add('hidden');
                currentBookingIndex = -1;
                bookings.splice(originalIndex, 1);
                applyFilters();
                // const statusText = newStatus === 'yes' ? 'Ù‚ÙØ¨Ù„' : newStatus === 'no' ? 'Ø±ÙÙØ¶' : 'ØªÙ… ØªØ­ÙˆÙŠÙ„Ù‡ Ù„Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©';
                // alert(`ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø¬Ø² - ${statusText} Ø¨Ù†Ø¬Ø§Ø­!`);

            }).catch(() => {
                alert("Ø­ØµÙ„Øª Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¯ ØªØ¶Ø·Ø± Ø§Ù„Ù‰ Ø§Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§Ø¯Ø®Ø§Ù„");
                location.reload();
            })
        }

        function exportData() {
            const columnsMap = {
                type: "Ù†ÙˆØ¹ Ø§Ù„Ù…Ù†Ø´Ø£Ø©",
                date: "Ø§Ù„ØªØ§Ø±ÙŠØ®",
                entityName: "Ø§Ø³Ù… Ø§Ù„Ø¬Ù‡Ø©",
                entityType: "Ù†ÙˆØ¹ Ø§Ù„Ø¬Ù‡Ø©",
                bookerName: "Ø§Ø³Ù… Ø§Ù„Ø­Ø§Ø¬Ø²",
                idNumber: "Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©",
                bookerPhone: "Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ø§Ù„Ø­Ø§Ø¬Ø²",
                managerName: "Ø§Ø³Ù… Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„",
                managerPhone: "Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„",
                timePeriod: "Ø§Ù„ÙØªØ±Ø©",
                entryTime: "ÙˆÙ‚Øª Ø§Ù„Ø¯Ø®ÙˆÙ„",
                exitTime: "ÙˆÙ‚Øª Ø§Ù„Ø®Ø±ÙˆØ¬",
                expectedCount: "Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø´Ø®Ø§Øµ",
                notes: "Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª",
                accepted: "Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø¬Ø²"
            };

            // Ù†Ø­ÙˆÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
            const translatedData = filteredBookings.map((item, i) => {
                const newItem = {};
                newItem["Ù…"] = i + 1;
                for (const key in columnsMap) {
                    newItem[columnsMap[key]] = item[key] ?? "";
                }
                return newItem;
            });

            const ws = XLSX.utils.json_to_sheet(translatedData);

            // ØªÙˆØ³ÙŠØ· Ø§Ù„Ù†ØµÙˆØµ ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø®Ù„Ø§ÙŠØ§
            const range = XLSX.utils.decode_range(ws['!ref']);
            for (let R = range.s.r; R <= range.e.r; ++R) {
                for (let C = range.s.c; C <= range.e.c; ++C) {
                    const cell_address = XLSX.utils.encode_cell({ r: R, c: C });
                    if (!ws[cell_address]) continue;
                    if (!ws[cell_address].s) ws[cell_address].s = {};
                    ws[cell_address].s.alignment = { horizontal: "center", vertical: "center" };
                }
            }

            // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§ØªØ¬Ø§Ù‡ (Ù…Ù† Ø§Ù„ÙŠÙ…ÙŠÙ† Ù„Ù„ÙŠØ³Ø§Ø±)
            ws['!rtl'] = true;

            // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Excel
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª");

            // Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù
            XLSX.writeFile(wb, "Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª.xlsx");
        }



        function filterByStatus(status) {
            // Set the status filter dropdown to the selected status
            document.getElementById('statusFilter').value = status;

            // Clear other filters to show only status-based results
            document.getElementById('bookingTypeFilter').value = '';
            document.getElementById('entityTypeFilter').value = '';
            document.getElementById('periodFilter').value = '';
            document.getElementById('timeFilter').value = '';
            document.getElementById('searchFilter').value = '';

            // Update card selection states
            updateCardSelection(status);

            // Apply the filters
            applyFilters();

            // Add visual feedback
            const statusText = status === 'yes' ? 'Ø§Ù„Ù…Ù‚Ø¨ÙˆÙ„Ø©' :
                status === 'pending' ? 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©' :
                    status === 'no' ? 'Ø§Ù„Ù…Ø±ÙÙˆØ¶Ø©' : 'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª';

            // Show a brief notification
            showNotification(`ØªÙ… Ø¹Ø±Ø¶ ${statusText}`);
        }

        function updateCardSelection(selectedStatus) {
            // Remove selected class from all cards
            const allCards = document.querySelectorAll('.stat-card');
            allCards.forEach(card => card.classList.remove('selected'));

            // Add selected class to the appropriate card
            let selectedCard;
            switch (selectedStatus) {
                case 'yes':
                    selectedCard = document.getElementById('acceptedCard');
                    break;
                case 'pending':
                    selectedCard = document.getElementById('pendingCard');
                    break;
                case 'no':
                    selectedCard = document.getElementById('rejectedCard');
                    break;
                default:
                    selectedCard = document.getElementById('totalCard');
                    break;
            }

            if (selectedCard) {
                selectedCard.classList.add('selected');
            }
        }

        function showNotification(message) {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-blue-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 fade-in';
            notification.textContent = message;

            // Add to page
            document.body.appendChild(notification);

            // Remove after 2 seconds
            setTimeout(() => {
                notification.remove();
            }, 2000);
        }

        // Event listeners
        document.getElementById('statusFilter').addEventListener('change', applyFilters);
        document.getElementById('bookingTypeFilter').addEventListener('change', applyFilters);
        document.getElementById('entityTypeFilter').addEventListener('change', applyFilters);
        document.getElementById('periodFilter').addEventListener('change', applyFilters);
        document.getElementById('timeFilter').addEventListener('change', applyFilters);
        document.getElementById('searchFilter').addEventListener('input', applyFilters);

        // Close modal when clicking outside
        document.getElementById('bookingModal').addEventListener('click', function (e) {
            if (e.target === this) {
                closeModal();
            }
        });

        document.getElementById('statusChangeModal').addEventListener('click', function (e) {
            if (e.target === this) {
                closeStatusChangeModal();
            }
        });

        // Initialize
        renderBookings();
    </script>
    <script>(function () { function c() { var b = a.contentDocument || a.contentWindow.document; if (b) { var d = b.createElement('script'); d.innerHTML = "window.__CF$cv$params={r:'9868fd2c20ecedcd',t:'MTc1OTEyMjc4Mi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);"; b.getElementsByTagName('head')[0].appendChild(d) } } if (document.body) { var a = document.createElement('iframe'); a.height = 1; a.width = 1; a.style.position = 'absolute'; a.style.top = 0; a.style.left = 0; a.style.border = 'none'; a.style.visibility = 'hidden'; document.body.appendChild(a); if ('loading' !== document.readyState) c(); else if (window.addEventListener) document.addEventListener('DOMContentLoaded', c); else { var e = document.onreadystatechange || function () { }; document.onreadystatechange = function (b) { e(b); 'loading' !== document.readyState && (document.onreadystatechange = e, c()) } } } })();</script>
</body>

</html>